{% extends "layouts/base.njk" %}

{% block content %}
    {{ 'Edit product' if product is defined and product else 'Create product' }}
<form method="post" action="{{ action }}">
  <label for="name">Name</label>
  <input type="text" id="name" name="name" value="{{ product.name if product else '' }}" required />

  <label for="description">Description</label>
  <textarea id="description" name="description" required>{{ product.description if product else '' }}</textarea>

  <label for="price">Price</label>
  <input type="number" step="0.01" id="price" name="price" value="{{ product.price if product else '' }}" required />

  <label for="currency">Currency</label>
  <input type="text" id="currency" name="currency" value="{{ product.currency if product else 'USD' }}" required />

  <label>Categories</label>
  <select name="categoryIds" multiple>
    {% for category in categories %}
      <option value="{{ category.id }}" {% if product and category.id in product.categoryIds %}selected{% endif %}>{{ category.name }}</option>
    {% endfor %}
  </select>

  <fieldset>
    <legend>Media</legend>
    <div id="media-list">
      {% set mediaItems = product.media if product else [] %}
      {% for media in mediaItems %}
        <div class="media-row">
          <input type="hidden" name="mediaId" value="{{ media.id }}" />
          <label>Image URL</label>
          <input type="url" name="mediaUrl" value="{{ media.url }}" required />
          <label>Alt text</label>
          <input type="text" name="mediaAltText" value="{{ media.altText }}" />
        </div>
      {% else %}
        <div class="media-row">
          <label>Image URL</label>
          <input type="url" name="mediaUrl" placeholder="https://" />
          <label>Alt text</label>
          <input type="text" name="mediaAltText" />
        </div>
      {% endfor %}
    </div>
    <button type="button" class="button button-outline" data-action="add-media">Add another image</button>
  </fieldset>

  <fieldset>
    <legend>Additional information</legend>
    <div id="additional-info-list">
      {% set infoItems = product.additionalInfo | dictsort if product else [] %}
      {% for item in infoItems %}
        {% set key = item[0] %}
        {% set value = item[1] %}
        <div class="info-row">
          <input type="text" name="additionalInfoKey" value="{{ key }}" placeholder="Label" />
          <input type="text" name="additionalInfoValue" value="{{ value }}" placeholder="Detail" />
        </div>
      {% else %}
        <div class="info-row">
          <input type="text" name="additionalInfoKey" placeholder="Label" />
          <input type="text" name="additionalInfoValue" placeholder="Detail" />
        </div>
      {% endfor %}
    </div>
    <button type="button" class="button button-outline" data-action="add-info">Add another field</button>
  </fieldset>

  <label for="customTemplate">Custom template (optional)</label>
  <input type="text" id="customTemplate" name="customTemplate" value="{{ product.customTemplate if product else '' }}" placeholder="custom-spotlight.njk" />

  <button type="submit" class="button-primary">{{ 'Save changes' if product is defined and product else 'Create product' }}</button>
</form>

<script>
  window.adminEnhancements = window.adminEnhancements || [];
  window.adminEnhancements.push(function () {
    document.querySelector('[data-action="add-media"]').addEventListener('click', function () {
      const container = document.getElementById('media-list');
      const template = document.createElement('div');
      template.className = 'media-row';
      template.innerHTML = `
        <label>Image URL</label>
        <input type="url" name="mediaUrl" placeholder="https://" />
        <label>Alt text</label>
        <input type="text" name="mediaAltText" />
      `;
      container.appendChild(template);
    });

    document.querySelector('[data-action="add-info"]').addEventListener('click', function () {
      const container = document.getElementById('additional-info-list');
      const row = document.createElement('div');
      row.className = 'info-row';
      row.innerHTML = `
        <input type="text" name="additionalInfoKey" placeholder="Label" />
        <input type="text" name="additionalInfoValue" placeholder="Detail" />
      `;
      container.appendChild(row);
    });
  });
</script>
{% endblock %}